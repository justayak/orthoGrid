(function(){var m=function(){};m.VERBOSE=!1;var s=1,q=m.Grid=function(d,b){this.h=b;this.w=d;var c=new ArrayBuffer(b*d),f=new ArrayBuffer(b*d*2);this.entities=[{name:"dummy"}];this.data=new Int8Array(c);this.userData=new Int16Array(f);this.trapLookup={}};q.createFromSmilaMap=function(d,b){m.VERBOSE&&console.log("[OG::Grid->createFromSmilaMap] beginning.. ");d.onReady(function(){var c=new q(d.w,d.h);if("undefined"!==typeof d.eventLayer)for(var f=0;f<d.w;f++)for(var g=0;g<d.h;g++){var e=d.eventLayer[f][g];
    0!==e&&(1!==e.id&&(c.trapLookup[f+"_"+g]=e),c.data[g*d.w+f]=e.id)}b(c)})};q.prototype.spawnEntity=function(d){var b=s;s+=1;d=new r(d,b,this);return this.entities[b]=d};q.prototype.getEntityAt=function(d,b){var c=this.userData[b*this.w+d];return 0===c?null:this.entities[c]};q.prototype.query=function(d,b,c,f){var g={};c=this.w;var e=this.userData,l=[],m=Math.min(d+c,this.w);for(f=Math.min(b+f,this.h);d<m;d++)for(var h=b;h<f;h++){var a=e[h*c+d];0===a||a in g||(g[a]=!0,l.push(this.entities[a]))}return l};
    q.prototype.print=function(d){for(var b="\nEntities:\n",c=0;c<this.h;c++){for(var f=0;f<this.w;f++)var g=this.userData[c*this.w+f],b=0===g?b+"_":b+g,b=b+"|";b+="\n"}b+="\n\nTraps:\n";for(c=0;c<this.h;c++){for(f=0;f<this.w;f++)g=this.data[c*this.w+f],b=0===g?b+"_":b+g,b+="|";b+="\n"}!0==d&&console.log(b);return b};var r=m.GridEntity=function(d,b,c){"undefined"===typeof d&&(d={});this.group=d.group||1;this.w=d.w||1;this.h=d.h||1;this.x=d.x||0;this.y=d.y||0;this.id=b;this.enterableEventIds=d.enterableEventIds||
        [];this.grid=c;this.eventListener=[];this.traps=[];if(1===this.w&&1===this.h)this.grid.userData[this.y*this.grid.w+this.x]=this.id;else{var f=this.grid.w;d=this.x+this.w;b=this.y+this.h;for(var g=this.x;g<d;g++)for(var e=this.y;e<b;e++)this.grid.userData[e*f+g]=this.id}d=this.x+this.w;b=this.y+this.h;for(g=this.x;g<d;g++)for(e=this.y;e<b;e++)if(0!==c.data[e*f+g]){var l={},m=g+"_"+e;m in c.trapLookup&&(l=c.trapLookup[m]);this.traps.push(l)}};r.prototype.validateEventId=function(d){if(0===d)return!0;
        if(1===d)return!1;if(0===this.enterableEventIds.length)return!0;for(var b=0;b<this.enterableEventIds.length;b++)if(this.enterableEventIds[b]===d)return!0;return!1};r.prototype.validatePosition=function(d,b){return 0!==this.grid.userData[b*this.grid.w+d]?!1:this.validateEventId(this.grid.data[b*this.grid.w+d])};var l=m.Directions={n:0,s:1,w:2,e:3,ne:4,nw:5,se:6,sw:7};r.prototype.onEvent=function(d){this.eventListener.push(d)};r.prototype.move=function(d){this.traps.length=0;var b=this.x,c=this.y;switch(d){case l.n:c-=
        1;break;case l.s:c+=1;break;case l.w:b-=1;break;case l.e:b+=1;break;case l.ne:b+=1;c-=1;break;case l.nw:b-=1;c-=1;break;case l.se:b+=1;c+=1;break;case l.sw:b-=1,c+=1}var b=Math.max(0,Math.min(b,this.grid.w-1)),c=Math.max(0,Math.min(c,this.grid.h-1)),f=c+this.h,g=b+this.w,e=this.grid.userData,m=this.grid.data,q=this.grid.trapLookup,h=this.grid.w;if(b!==this.x||c!==this.y)if(1===this.w&&1===this.h){if(0===e[c*h+b]&&(d=m[c*h+b],1!==d&&(0===d||this.validateEventId(d))&&(e[c*h+b]=this.id,e[this.y*h+this.x]=
        0,this.x=b,this.y=c,0!==d)))for(m={},e=b+"_"+c,(e in q)&&(m=q[e]),b=0;b<this.eventListener.length;b++)this.eventListener[b].call(this,d,m)}else{var a=0,a=0,k=!0,n=0,p=0;switch(d){case l.n:n=c+this.h;for(a=b;a<g;a++)if(!this.validatePosition(a,c)){k=!1;break}if(k){for(a=b;a<g;a++)e[c*h+a]=this.id,e[n*h+a]=0;this.y=c}break;case l.s:n=this.y+this.h;for(a=b;a<g;a++)if(!this.validatePosition(a,n)){k=!1;break}if(k){for(a=b;a<g;a++)e[n*h+a]=this.id,e[this.y*h+a]=0;this.y=c}break;case l.w:for(a=c;a<f&&this.validatePosition(b,
        a);a++)if(k){p=b+this.w;for(a=c;a<f;a++)e[a*h+b]=this.id,e[a*h+p]=0;this.x=b}break;case l.e:p=this.x+this.w;for(a=c;a<f;a++)if(!this.validatePosition(p,a)){k=!1;break}if(k){for(a=c;a<f;a++)e[a*h+p]=this.id,e[a*h+this.x]=0;this.x=b}break;case l.ne:for(a=b;a<g;a++)if(!this.validatePosition(a,c)){k=!1;break}if(k){p=this.x+this.w;for(a=c+1;a<f;a++)if(!this.validatePosition(p,a)){k=!1;break}if(k){for(a=b;a<g;a++)e[c*h+a]=this.id,e[f*h+(a-1)]=0;for(a=c+1;a<f;a++)e[a*h+p]=this.id,e[a*h+this.x]=0;this.x=
        b;this.y=c}}break;case l.nw:for(a=b;a<g;a++)if(!this.validatePosition(a,c)){k=!1;break}if(k){for(a=c+1;a<f;a++)if(!this.validatePosition(b,a)){k=!1;break}if(k){n=c+this.h;p=b+this.w;for(a=b;a<g;a++)e[c*h+a]=this.id,e[n*h+(a+1)]=0;for(a=c+1;a<f;a++)e[a*h+b]=this.id,e[a*h+p]=0;this.x=b;this.y=c}}break;case l.se:n=f-1;p=this.x+this.w;for(a=b;a<g;a++)if(!this.validatePosition(a,n)){k=!1;break}if(k){for(a=c+1;a<f;a++)if(!this.validatePosition(p,a-1)){k=!1;break}if(k){for(a=b;a<g;a++)e[n*h+a]=this.id,e[this.y*
        h+(a-1)]=0;for(a=c+1;a<f;a++)e[(a-1)*h+p]=this.id,e[(a-1)*h+this.x]=0}this.x=b;this.y=c}break;case l.sw:n=f-1;for(a=b;a<g;a++)if(!this.validatePosition(a,n)){k=!1;break}if(k){for(a=c+1;a<f;a++)if(!this.validatePosition(b,a-1)){k=!1;break}if(k){for(a=b;a<g;a++)e[n*h+a]=this.id,e[this.y*h+(a+1)]=0;for(a=c+1;a<f;a++)e[(a-1)*h+b]=this.id,e[(a-1)*h+g]=0;this.x=b;this.y=c}}}}for(b=this.x;b<g;b++)for(c=this.y;c<f;c++)d=m[c*h+b],0!==d&&(d={},e=b+"_"+c,e in q&&(d=q[e]),this.traps.push(d));return this};r.prototype.forcePosition=
        function(d,b){if(1===this.w&&1===this.h)this.grid.userData[this.y*this.grid.w+this.x]=0,this.grid.userData[this.y*this.grid.w+this.x]=this.id;else{var c=this.grid.w,f=this.x+this.w,g=this.y+this.h;for(d=this.x;d<f;d++)for(b=this.y;b<g;b++)this.grid.userData[b*c+d]=0;f=d+this.w;g=b+this.h;for(d=this.x;d<f;d++)for(b=this.y;b<g;b++)this.grid.userData[b*c+d]=this.id}};"undefined"!==typeof module&&module.exports?(module.exports=m,this&&(this.OG=m)):(this&&(this.OG=m),window.OG=m)})();